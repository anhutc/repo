$(() => {
    let o;
    for (const e of location.search.substring(1).split("&")) {
        var t = e.split("=");
        "p" == decodeURIComponent(t[0]) && (o = decodeURIComponent(t[1]))
    }
    if (o) {
        let a = !0,
            r = "";
        console.log("Gói: " + o);
        const s = location.href.split("?")[0] + o,
            d = "https://api.github.com/repos/anhutc/repo/commits?path=debs/";
        $.ajax({
            type: "GET",
            url: s + "/info.xml",
            dataType: "xml"
        }).done(n => {
            console.log("Bắt đầu phân tích cú pháp XML."), $(n).find("packageInfo").each(function() {
                document.title = $(this).find("name").text().trim() + " - DVA Repo";
                var t = $(this).find("changeVersion:first").text().replace("v", "").trim(),
                    [t, e, i] = (compatible($(this).find("miniOS").text().trim(), $(this).find("maxiOS").text().trim()), $(n).find("description").each(function() {
                        $("#description").append("<li>" + $(this).text().trim() + "</li>")
                    }), $(n).find("dependency").each(function() {
                        $("#dependencies").append("<li>" + $(this).text().trim() + "</li>")
                    }), $(n).find("change:first").each(function() {
                        $("#pill").append($(this).find("changeVersion").text().trim()), r += "<li>", $(this).find("changeDescription").each(function() {
                            r += "<h2>- " + $(this).text().trim() + "</h2>"
                        }), r += "</li>"
                    }), lastUpdateDate(d + o + "_" + t + "_iphoneos-arm.deb").then(t => $("#changelog-date").append(t)).catch(t => console.error(t)),
                    $("#changelog").append(r + '<table><tr><td><a href="changelog/?p=' + o + '">Tất cả thay đổi</a></td></tr></table>'),
                    $(n).find("screen").each(function() {
                        a = !1,
                        $("#screenshots").append('<li><a href="' + s + "/" + $(this).text().trim() + '" target="_blank"><img src="' + s + "/" + $(this).text().trim() + '" draggable="false" /></a></li>')
                    }), a && $("#screenshots").append("<li>Không có ảnh chụp màn hình nào được cung cấp.</li>"),
                    $("#infoTable").append("<tr><th>Nhà Phát triển</th><td>" + $(this).find("developer").text().trim() + "</td></tr>"),
                    $("#infoTable").append("<tr><th>Giá</th><td>" + $(this).find("price").text().trim() + "</td></tr>"),
                    $("#infoTable").append("<tr><th>Phiên bản</th><td>" + t + "</td></tr>"),
                    $("#infoTable").append("<tr><th>Phiên bản iOS</th><td>iOS " + $(this).find("miniOS").text().trim() + " - " + $(this).find("maxiOS").text().trim() + "</td></tr>"),
                    $("#infoTable").append('<tr><th>Cập nhật lần cuối</th></td><td id="last-update"></td></tr>'),
                    $("#infoTable").append('<tr><th>Ngày phát hành</th></td><td id="release-date"></td></tr>'), lastUpdateDate(d + o + "_" + t + "_iphoneos-arm.deb").then(t => $("#last-update").append(t)).catch(t => console.error(t)), lastUpdateDate(d + o + "_" + $(this).find("changeVersion:last").text().replace("v", "").trim() + "_iphoneos-arm.deb").then(t => $("#release-date").append(t)).catch(t => console.error(t)),
                    $("#infoTable").append("<tr><th>Thể loại</th><td>" + $(this).find("category").text().trim() + "</td></tr>"),
                    $("#links").append('<tr><td><a href="' + $(this).find("facebook").text().trim() + '" target="_blank"><img src="https://is2-ssl.mzstatic.com/image/thumb/Purple122/v4/3c/91/d4/3c91d436-979d-0aec-77e9-d7aef90ef25f/Icon-Production-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/217x0w.png" alt="Facebook icon" />Facebook</a></td></tr>'),
                    $("#links").append('<tr><td><a href="' + $(this).find("youtube").text().trim() + '" target="_blank"><img src="https://is2-ssl.mzstatic.com/image/thumb/Purple112/v4/c4/66/40/c46640b4-1857-a8b9-c76b-6a3817f03d05/logo_youtube_color-0-0-1x_U007emarketing-0-0-0-6-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/217x0w.png" alt="Youtube icon" />Youtube</a></td></tr>'),
                    $("#links").append('<tr><td><a href="' + $(this).find("tiktok").text().trim() + '" target="_blank"><img src="https://is5-ssl.mzstatic.com/image/thumb/Purple112/v4/9f/06/45/9f06455f-0d5e-6cde-3bff-9e9e4823bbf5/AppIcon_TikTok-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/217x0w.png" alt="TikTok icon" />TikTok</a></td></tr>'),
                    $("#links").append('<tr><td><a href="' + $(this).find("mail").text().trim() + '" target="_blank"><img src="https://is1-ssl.mzstatic.com/image/thumb/Purple123/v4/c7/40/e5/c740e5f0-2a62-4fa7-dc1b-66ea3d519545/AppIcon-0-1x_U007emarketing-0-0-GLES2_U002c0-512MB-sRGB-0-0-0-85-220-0-0-0-10.png/217x0w.png" alt="Apple Mail icon" />Mail</a></td></tr>'),
                    $("#links").append('<tr><td><a href="' + $(this).find("paypal").text().trim() + '" target="_blank"><img src="https://is5-ssl.mzstatic.com/image/thumb/Purple125/v4/66/37/0d/66370de2-4c2c-43d2-1f2b-dd4b0c5e563a/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/217x0w.png" alt="PayPal icon" />Paypal</a></td></tr>')
            )}), console.log("Đã hoàn thành phân tích cú pháp XML.")
        }).fail(() => {
            var t = 'Gói "' + o + '" không tìm thấy. Tham số không chính xác hoặc không có mô tả cho gói này.';
            $("#compatibility").append("Không xác định"),
            $("#description").append("<li>" + t + "</li>"),
            $("#pill").append("v?"),
            $("#changelog-date").append("../../...."),
            $("#changelog").append("Không có sẵn"),
            $("#dependencies").append("Lỗi"),
            $("#screenshots").append("Không có ảnh chụp màn hình"),
            $("#infoTable").append("Không có thông tin"),
            $("#links").append("Không có sẵn")
        })
    } else console.log("Gói hàng không được tìm thấy. Hủy bỏ.")
}), $("img").bind("dragstart", () => !1), $("img").bind("mousedown", () => !1);
let updateDatesDict = {};

function lastUpdateDate(o) {
    function t(n) {
        return new Promise((t, e) => {
            const i = new XMLHttpRequest;
            i.onload = () => {
                200 == i.status && 4 == i.readyState && t(i.response), e(i.status)
            }, i.onerror = () => e(i.status), i.open("GET", n), i.send()
        })
    }
    return new Promise((r, e) => {
        if (o in updateDatesDict) console.log("Sử dụng giá trị được lưu trong bộ nhớ cache cho url " + o + " (" + updateDatesDict[o] + ")"), r(updateDatesDict[o]);
        else {
            let a = 0;
            const i = () => {
                t(o).then(n => {
                    t(String(o).replace("mmits?path=", "ntents/").concat("?ref=", JSON.parse(n)[a].sha)).then(t => {
                        const e = new Date(JSON.parse(n)[a].commit.author.date);
                        console.log("Ngày tìm nạp thành công cho url: " + o + " (" + e + ")");
                        var i = e.toLocaleDateString("en-US", {
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit"
                        });
                        updateDatesDict[o] = i, r(i)
                    }).catch(t => {
                        a++, console.warn("Thử lại cuộc gọi với cam kết " + a + " cho url " + o), i()
                    })
                }).catch(t => {
                    e("Lỗi khi nhận giá trị sha (" + t + ")")
                })
            };
            i()
        }
    })
}

function compatible(t, e) {
    var i, n = parseFloat(("" + (/CPU.*OS ([0-9_]+)|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent) || [0, ""])[1]).replace("undefined", "3_2").replace("_", ".").replace("_", ""));
    t = numerize(t), e = numerize(e);
    const a = document.getElementById("compatibility"),
        r = document.getElementById("compatibility-box");
    n < t ? (a.innerHTML = "Phiên bản iOS của bạn quá cũ cho gói này. Nó tương thích từ iOS " + t + " - " + e + ".", a.style.color = "red", r.style.backgroundColor = "lightpink", r.style.border = "1px solid red") : e < n ? (t = "Gói này chưa được thử nghiệm với phiên bản iOS của bạn", i = "Bản cập nhật mới nhất chính thức hỗ trợ lên iOS " + e + ".", ~~n == ~~e ? (a.innerHTML = t + ", nhưng có thể hoạt động tốt. " + i, a.style.color = "goldenrod", r.style.backgroundColor = "lightyellow", r.style.border = "1px solid goldenrod") : (a.innerHTML = t + ", và có thể không hoạt động bình thường. " + i, a.style.color = "lightgoldenrodyellow", r.style.backgroundColor = "darkgoldenrod", r.style.border = "1px solid orange")) : isNaN(n) ? (a.innerHTML = "Không thể xác định phiên bản của bạn. Mở trang này trên thiết bị iOS để kiểm tra tính tương thích.", a.style.fontStyle = "italic") : (a.innerHTML = "Gói này hoạt động trên thiết bị của bạn!", a.style.color = "green", r.style.backgroundColor = "lightgreen", r.style.border = "1px solid green")
}

function numerize(t) {
    return t.substring(0, t.indexOf(".")) + "." + t.substring(t.indexOf(".") + 1).replace(".", "")
}